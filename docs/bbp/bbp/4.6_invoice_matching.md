4.6 Supplier Invoice Matching (3-way / 4-way)
Template Ref: _txn_03 (Medium/Complex Transaction)
4.6.1 Business Purpose
Supplier Invoice Matching validates a supplier invoice against what was ordered (PO) and what was received (GRN and QC), before it becomes a payable liability in Finance/AP.
Goals:
Prevent overbilling, duplicate billing, and fraud.


Ensure that only valid, matched invoices are approved for payment.


Support:


2-way match: Invoice ↔ PO (for services/recurring)


3-way match: Invoice ↔ PO ↔ GRN (standard goods)


4-way match: Invoice ↔ PO ↔ GRN ↔ QC (for items requiring QC)


Capture and route exceptions:


Price variance


Quantity variance


Tax mismatch


Unmatched invoice (no PO/GRN reference)


Feed Vendor Performance (billing accuracy) and Payment & Settlement.


Hybrid behavior (config-driven):
Matching model can vary by:


Company


Location / Business Unit


Category (Capex, Services, Consumables, Imports)


Tolerances can be configured by:


Amount (% or absolute)


Tax variance


Price vs last PO / contract.



4.6.2 Data Model
A) Supplier Invoice Header (supplier_invoice)
Field
Type
Required
Description
id
UUID
Yes
Primary key
company_id
FK
Yes
Company scope
supplier_id
FK (Supplier)
Yes
Supplier issuing invoice
invoice_number
String(50)
Yes
Supplier’s invoice number
invoice_status
Enum
Yes
DRAFT, VALIDATED, MATCHED, EXCEPTION, APPROVAL_PENDING, APPROVED, POSTED, REJECTED, CANCELLED
invoice_date
Date
Yes
Invoice date
posting_date
Date
No
AP posting date (finance integration)
currency_code
String(10)
Yes
Invoice currency
total_invoice_amount
Decimal
Yes
As per invoice document (gross)
total_tax_amount
Decimal
Yes
Total tax on invoice
total_net_amount
Decimal
Yes
Net amount (if needed)
po_id
FK (PO Header)
No
Primary PO this invoice claims to belong to (optional if multi-PO)
grn_id
FK (GRN Header)
No
Optional primary GRN reference
match_type
Enum
Yes
TWO_WAY, THREE_WAY, FOUR_WAY
match_status
Enum
Yes
UNMATCHED, PARTIALLY_MATCHED, FULLY_MATCHED, MATCH_WITH_VARIANCE
match_variance_amount
Decimal
Yes
Total variance amount vs matched reference(s)
match_variance_reason
Text
No
Summary of main variance reasons
payment_terms_code
String(50)
No
Payment terms (default from supplier, can be overridden)
due_date
Date
No
Derived from invoice_date + payment_terms
source_capture_method
Enum
Yes
MANUAL_ENTRY, VENDOR_PORTAL, OCR_UPLOAD, EDI_API
duplicate_check_signature
String(200)
No
Hash derived from supplier+invoice# etc.
duplicate_flag
Boolean
Yes
System-detected potential duplicate
approval_required
Boolean
Yes
Based on value/variance/rules
approved_by_user_id
FK (User)
No
Who approved this invoice for posting/payment
approved_at
DateTime
No
Approval timestamp
rejected_by_user_id
FK (User)
No
If invoice was rejected
rejected_at
DateTime
No
Rejection timestamp
remarks_internal
Text
No
Notes for AP/procurement only
created_by_user_id
FK (User)
Yes
Invoice captured by
created_at
DateTime
Auto


updated_at
DateTime
Auto



Note: Multi-PO and multi-GRN linking can be handled via detail/match table below.

B) Supplier Invoice Line (supplier_invoice_line)
Field
Type
Required
Description
id
UUID
Yes
Primary key
supplier_invoice_id
FK (Invoice Header)
Yes
Invoice header
item_id
FK (Item)
No
May be null for non-catalog items
item_variant_id
FK (Item Variant)
No
Same as above
description
String(255)
Yes
Line description from invoice
uom_id
FK (UOM)
No
UOM if structured
qty_invoiced
Decimal
Yes
Quantity as per invoice
unit_price_invoiced
Decimal
Yes
Price per unit as per invoice
line_gross_amount_invoiced
Decimal
Yes
= qty_invoiced × unit_price_invoiced (before tax)
tax_percent_invoiced
Decimal
No
Tax rate applied (if line-wise)
tax_amount_invoiced
Decimal
No
Line tax amount
line_net_amount_invoiced
Decimal
No
Gross + tax or gross - discount + tax
gl_account_code
String(50)
No
For service invoices / non-PO lines
line_remarks
Text
No
Any notes


C) Invoice Match Detail (supplier_invoice_match_detail)
Connects invoice lines to PO/GRN/QC, enabling 2-way/3-way/4-way matching.
Field
Type
Required
Description
id
UUID
Yes
Primary key
supplier_invoice_line_id
FK (Invoice Line)
Yes
Invoice line
purchase_order_line_id
FK (PO Line)
No
For 2/3/4-way match
goods_receipt_note_line_id
FK (GRN Line)
No
For 3/4-way match
qc_status_at_match
Enum
No
NOT_REQUIRED, PENDING, PASSED, FAILED, etc.
matched_qty
Decimal
Yes
Qty considered for matching
matched_unit_price
Decimal
Yes
Reference unit price (from PO/RFQ/Contract)
matched_tax_percent
Decimal
No
Tax rate from PO or master
qty_variance
Decimal
Yes
qty_invoiced - matched_qty
price_variance
Decimal
Yes
unit_price_invoiced - matched_unit_price
tax_variance
Decimal
Yes
tax_invoiced - matched_tax
variance_amount_total
Decimal
Yes
Monetary impact of variances
variance_status
Enum
Yes
WITHIN_TOLERANCE, EXCEEDS_TOLERANCE
variance_reason_code
String(50)
No
Under/over billing, extra charges, tax diff
manual_override_flag
Boolean
Yes
True if user forced override
override_justification
Text
No
Reason for override (if any)


D) Config / Control (Conceptual)
Sample controls:
invoice_matching_model per category/location:


TWO_WAY, THREE_WAY, FOUR_WAY


Tolerances:


qty_tolerance_percent


price_tolerance_percent


tax_tolerance_percent


amount_tolerance_absolute


auto_match_if_within_tolerance (Yes/No)


block_posting_if_qc_failed (Yes/No)


block_posting_if_duplicate_flag = true (or require override)



4.6.3 UI / UX Requirements
Screen Name: Supplier Invoice Matching
 Path: Procurement / AP → Supplier Invoices

A) Invoice List
Columns:
Invoice Number


Invoice Date


Supplier


PO Number (if any)


GRN Number (if any)


Status


Match Status


Variance Amount


Created By / Approved By


Source (Manual/OCR/Portal/EDI)


Filters:
Date range (Invoice Date, Posting Date)


Supplier


Status (DRAFT, MATCHED, EXCEPTION, etc.)


Match Type (2-Way, 3-Way, 4-Way)


Has Variance? (Yes/No)


Duplicate Flag (Yes/No)


Actions:
Capture New Invoice


View/Edit (DRAFT/VALIDATED only)


Run Auto-Match


Send for Approval


Approve / Reject


Post to Finance (once approved)



B) Invoice Capture Form (Header)
Sections:
Invoice Details


Supplier (lookup)


Invoice Number


Invoice Date


Currency


Invoice Total


Tax Total


Source Method (Manual/OCR/Portal/EDI)


Reference


Link to PO(s)


Link to GRN(s) (optional)


Match Type (auto-suggested by config)


System Info


Invoice Status


Match Status


Duplicate Flag


Approval Required? (Yes/No)



C) Invoice Lines View
Columns:
Line No


Description


Item Code / SKU (if identified)


UOM


Qty Invoiced


Unit Price


Line Gross


Tax %


Tax Amount


Line Net


Matched PO/GRN reference indicator


Features:
Auto-suggestion of PO/GRN mapping based on:


Supplier, item, quantity, amount, period.


Manual line-to-PO/GRN linking when auto-match not possible.



D) Matching View (Core UX)
Dedicated pane/tab:
Show for each invoice line:


Invoice line values (qty, price, tax)


PO line reference:


Ordered Qty


PO Unit Price


GRN line reference:


Received Qty


Accepted Qty


QC Result (for 4-way)


Show variance:


Qty variance


Price variance


Tax variance


Within/Outside tolerance highlight


Actions per line:


Accept (within tolerance)


Flag as Exception (outside tolerance)


Override (if role allows; requires justification)



4.6.4 Validation Rules
Header-level:
Supplier + invoice_number combination must be unique (or flagged duplicate).


invoice_date must be <= posting date (if posting date used).


Total of invoice lines must reconcile with total_invoice_amount and total_tax_amount (allow small rounding difference config).


If matching model requires PO:


At least one PO is linked or resolvable.


If matching model requires GRN:


At least one GRN is linked or resolvable.


Line-level:
qty_invoiced > 0.


If mapped to PO line:


qty_invoiced + already_invoiced_qty <= accepted_qty_from_grn * (1 + qty_tolerance_percent).


If mapped to GRN line:


Finance should not invoice beyond accepted quantity.


Price variance vs PO:


If beyond tolerance, line flagged as exception; invoice cannot move to MATCHED until resolved.


Matching/Status-level:
Invoice cannot be set to MATCHED unless:


All lines are either:


Matched within tolerance, or


Exception is flagged and routed for approval.


Cannot POST to Finance unless:


Status is APPROVED.



4.6.5 Workflow
Default:
DRAFT
 → Validate (auto-match attempt) → VALIDATED
 → If fully matched within tolerance → MATCHED → APPROVAL_PENDING → APPROVED → POSTED


Exception path:
VALIDATED → match variance outside tolerance → EXCEPTION
 → Send to approver → APPROVAL_PENDING → APPROVED or REJECTED
 → If approved, can still be POSTED with variances documented.


Rejection path:
EXCEPTION / APPROVAL_PENDING → REJECTED (if invoice is disputed with supplier)


Cancellation:
DRAFT / VALIDATED → CANCELLED (if captured incorrectly or voided)



4.6.6 Module Metadata & Build Steps
Module Metadata
module_type: transaction
complexity: medium_to_complex

template_ref: _txn_03

extension_allowed: true

depends_on:
  - Company
  - Suppliers
  - Purchase Order (4.3)
  - GRN & QC (4.5)
  - QC Rules (for 4-way)
  - Finance/AP (for posting)
  - Users / Roles
  - Tolerance & Matching Config

used_by:
  - Payments & Settlement (4.8)
  - Vendor Performance (4.9)
  - Tax & Compliance Reporting


Build Steps (for AI / Implementation Engine)
You are building a Medium-to-Complex Transaction module for a Retail ERP.

Module: Supplier Invoice Matching (3-way / 4-way)
Template: _txn_03

Requirements:

1) Backend (Django + DRF):

   Models:
   - supplier_invoice (header)
   - supplier_invoice_line (lines)
   - supplier_invoice_match_detail (matching details)

   Serializers:
   - Invoice header with nested lines.
   - Matching detail serializer.

   Viewsets & Endpoints:
   - Capture invoice (CRUD while in DRAFT).
   - Auto-match endpoint:
     - Tries to match lines to PO/GRN/QC using configured rules.
   - Manual match endpoint:
     - For user-driven mapping.
   - Workflow:
     - validate_invoice
     - mark_matched
     - send_for_approval
     - approve_invoice
     - reject_invoice
     - post_invoice (integration handoff to Finance/AP).

   Business Rules:
   - Enforce uniqueness and tolerance rules.
   - Keep aggregated match_variance_amount up to date.
   - Respect configuration for match type and tolerance per category.

2) Frontend (React + Vite + Tailwind):

   Screens:
   - Invoice List (filters, status indicators).
   - Invoice Capture/Edit:
     - Header + lines + basic references.
   - Matching View:
     - Side-by-side comparison of invoice vs PO vs GRN (+ QC).

   Behavior:
   - Display clear variance warnings.
   - Block approval/posting when rules are violated.
   - Support inline justification capture for overrides.

3) Integration:

   - Upstream:
     - Fetch POs and GRNs for supplier and date window.
   - Downstream:
     - Expose approved, matched invoices to Payments module (4.8).
     - Provide variance data to Vendor Performance (4.9).

4) Security & Roles:

   - Roles:
     - Invoice Capturer
     - Invoice Matcher / Analyst
     - Invoice Approver
     - Finance Poster

Ensure full fidelity with the data, workflow, and validation rules
defined in the Supplier Invoice Matching specification.

